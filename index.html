<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KangTok Live Interactive</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white">

  <div id="root"></div>

  <script type="module">
    import React, { useState, useEffect, useRef } from "https://cdn.skypack.dev/react";
    import ReactDOM from "https://cdn.skypack.dev/react-dom";

    function App() {
      const [status, setStatus] = useState({ status: 'disconnected', message: '' });
      const [messages, setMessages] = useState([]);
      const [backgrounds, setBackgrounds] = useState([]);
      const [selectedBg, setSelectedBg] = useState(null);
      const [soundEffects, setSoundEffects] = useState({});
      const [isLikesSoundOn, setIsLikesSoundOn] = useState(true);
      const [isFollowsSoundOn, setIsFollowsSoundOn] = useState(true);
      const [isGiftsSoundOn, setIsGiftsSoundOn] = useState(true);
      const [volume, setVolume] = useState(0.5);
      const [floatingPics, setFloatingPics] = useState([]);

      const wsRef = useRef(null);

      useEffect(() => {
        const socket = new WebSocket("ws://localhost:3000");
        wsRef.current = socket;

        socket.onopen = () => {
          setStatus({ status: 'connected', message: 'Terhubung ke server' });
        };

        socket.onmessage = (event) => {
          const data = JSON.parse(event.data);
          if (data.type === 'chat') {
            setMessages(prev => [...prev, data]);
            addFloatingPic(data);
            if (data.subType === 'like') playSoundEffect('like');
            if (data.subType === 'follow') playSoundEffect('follow');
            if (data.subType === 'gift') playSoundEffect('gift');
          } else if (data.type === 'assets') {
            setBackgrounds(data.backgrounds || []);
            setSoundEffects(data.sounds || {});
          }
        };

        socket.onclose = () => {
          setStatus(prev => {
            if (prev.status === 'connected' || prev.status === 'connecting') {
              return { status: 'disconnected', message: 'Koneksi terputus. Silakan hubungkan kembali.' };
            }
            return prev;
          });
        };

        return () => socket.close();
      }, []);

      const playSoundEffect = (type) => {
        if (!soundEffects[type]) return;
        if (type === 'like' && !isLikesSoundOn) return;
        if (type === 'follow' && !isFollowsSoundOn) return;
        if (type === 'gift' && !isGiftsSoundOn) return;

        try {
          const audio = new Audio(soundEffects[type]);
          audio.volume = volume;
          audio.play().catch(e => console.error("Error playing sound:", e));
        } catch (error) {
          console.error("Could not play sound effect:", error);
        }
      };

      const addFloatingPic = (data) => {
        if (!data.profilePictureUrl) return;
        const id = Date.now();
        const top = Math.random() * 80 + "%";
        const left = Math.random() * 80 + "%";
        const animationName = `float-${id}`;
        const newPic = { id, url: data.profilePictureUrl, top, left, animationName };

        const style = document.createElement("style");
        style.innerHTML = `
          @keyframes ${animationName} {
            0% { transform: scale(0) rotate(0deg); opacity: 1; }
            50% { transform: scale(1.2) rotate(180deg); opacity: 0.8; }
            100% { transform: scale(0) rotate(360deg); opacity: 0; }
          }
        `;
        document.head.appendChild(style);

        setFloatingPics(prev => [...prev, newPic]);
        setTimeout(() => {
          setFloatingPics(prev => prev.filter(p => p.id !== id));
          document.head.removeChild(style);
        }, 60000);
      };

      return (
        <div className="relative w-full h-screen overflow-hidden" style={{ backgroundImage: selectedBg ? `url(${selectedBg})` : 'none', backgroundSize: 'cover' }}>
          {/* Status */}
          <div className="absolute top-2 left-2 bg-black bg-opacity-60 px-3 py-1 rounded">
            {status.message || status.status}
          </div>

          {/* Messages */}
          <div className="absolute bottom-0 w-full max-h-1/3 overflow-y-auto bg-black bg-opacity-40 p-3 space-y-1">
            {messages.map((msg, idx) => (
              <div key={idx} className="text-sm flex items-center space-x-2">
                <img src={msg.profilePictureUrl} alt={`Foto profil ${msg.uniqueId || 'user'}`} className="w-6 h-6 rounded-full"/>
                <span className="font-bold">{msg.nickname || msg.uniqueId}:</span>
                <span>{msg.comment || msg.subType}</span>
              </div>
            ))}
          </div>

          {/* Floating Pictures */}
          {floatingPics.map(pic => (
            <img
              key={pic.id}
              src={pic.url}
              alt="Foto profil pengguna"
              className="w-14 h-14 rounded-full absolute border-2 border-white shadow-lg"
              style={{
                top: pic.top,
                left: pic.left,
                animation: `${pic.animationName} 60s ease-in-out forwards`
              }}
            />
          ))}

          {/* Controls */}
          <div className="absolute top-2 right-2 bg-black bg-opacity-60 p-4 rounded space-y-2">
            <h2 className="font-bold mb-2">Kontrol</h2>
            <div className="flex items-center justify-between">
              <label>Suara Like</label>
              <input type="checkbox" checked={isLikesSoundOn} onChange={() => setIsLikesSoundOn(v => !v)} />
            </div>
            <div className="flex items-center justify-between">
              <label>Suara Follow</label>
              <input type="checkbox" checked={isFollowsSoundOn} onChange={() => setIsFollowsSoundOn(v => !v)} />
            </div>
            <div className="flex items-center justify-between">
              <label>Suara Gift</label>
              <input type="checkbox" checked={isGiftsSoundOn} onChange={() => setIsGiftsSoundOn(v => !v)} />
            </div>
            <div>
              <label>Volume</label>
              <input type="range" min="0" max="1" step="0.1" value={volume} onChange={(e) => setVolume(parseFloat(e.target.value))}/>
            </div>
            <div>
              <label>Background</label>
              <select value={selectedBg || ""} onChange={(e) => setSelectedBg(e.target.value)} className="text-black">
                <option value="">Default</option>
                {backgrounds.map((bg, idx) => (
                  <option key={idx} value={bg}>{bg}</option>
                ))}
              </select>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById("root"));
  </script>
</body>
</html>
