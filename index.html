<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KangTok Live Interactive</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white">
  <div id="root"></div>

  <script type="module">
    import React, { useState, useEffect, useRef } from "https://cdn.skypack.dev/react";
    import ReactDOM from "https://cdn.skypack.dev/react-dom";

    function App() {
      const [status, setStatus] = useState({ status: 'disconnected', message: '' });
      const [messages, setMessages] = useState([]);
      const [backgrounds, setBackgrounds] = useState([]);
      const [selectedBg, setSelectedBg] = useState(null);
      const [soundEffects, setSoundEffects] = useState({});
      const [isLikesSoundOn, setIsLikesSoundOn] = useState(true);
      const [isFollowsSoundOn, setIsFollowsSoundOn] = useState(true);
      const [isGiftsSoundOn, setIsGiftsSoundOn] = useState(true);
      const [volume, setVolume] = useState(0.5);
      const [floatingPics, setFloatingPics] = useState([]);

      const wsRef = useRef(null);

      // ðŸ”¹ Ambil asset backgrounds & playlist via API
      useEffect(() => {
        fetch("/api/backgrounds")
          .then(res => res.json())
          .then(data => setBackgrounds(data || []))
          .catch(err => console.error("Gagal ambil backgrounds:", err));

        fetch("/api/playlist")
          .then(res => res.json())
          .then(data => setSoundEffects(data || {}))
          .catch(err => console.error("Gagal ambil playlist:", err));
      }, []);

      // ðŸ”¹ Setup WebSocket
      useEffect(() => {
        const wsUrl = (window.location.protocol === "https:" ? "wss://" : "ws://") 
                      + window.location.host;
        const socket = new WebSocket(wsUrl);
        wsRef.current = socket;

        socket.onopen = () => {
          setStatus({ status: 'connected', message: 'Terhubung ke server' });
        };

        socket.onmessage = (event) => {
          const data = JSON.parse(event.data);
          if (data.type === 'chat') {
            setMessages(prev => [...prev, data]);
            addFloatingPic(data);
            if (data.subType === 'like') playSoundEffect('like');
            if (data.subType === 'follow') playSoundEffect('follow');
            if (data.subType === 'gift') playSoundEffect('gift');
          }
        };

        socket.onclose = () => {
          setStatus(prev => ({
            status: 'disconnected',
            message: 'Koneksi terputus. Silakan hubungkan kembali.'
          }));
        };

        return () => socket.close();
      }, []);

      // ðŸ”¹ Helper untuk mainkan sound
      function playSoundEffect(type) {
        if (!soundEffects[type]) return;
        const audio = new Audio(soundEffects[type]);
        audio.volume = volume;
        if (type === 'like' && isLikesSoundOn) audio.play();
        if (type === 'follow' && isFollowsSoundOn) audio.play();
        if (type === 'gift' && isGiftsSoundOn) audio.play();
      }

      // ðŸ”¹ Animasi gambar melayang
      function addFloatingPic(data) {
        if (!data?.profilePic) return;
        const id = Date.now();
        setFloatingPics(prev => [...prev, { id, url: data.profilePic }]);
        setTimeout(() => {
          setFloatingPics(prev => prev.filter(pic => pic.id !== id));
        }, 5000);
      }

      return (
        <div className="min-h-screen flex flex-col items-center justify-center">
          <h1 className="text-2xl font-bold mb-4">KangTok Live Interactive</h1>
          <p className="mb-4">{status.message}</p>

          <div className="grid grid-cols-3 gap-4 mb-6">
            {backgrounds.map((bg, i) => (
              <button key={i} className="p-2 bg-gray-700 rounded-lg hover:bg-gray-600"
                onClick={() => setSelectedBg(bg)}>
                {bg}
              </button>
            ))}
          </div>

          <div className="w-full max-w-lg h-64 bg-gray-800 rounded-lg overflow-y-auto p-4">
            {messages.map((msg, i) => (
              <p key={i} className="mb-2">
                <span className="font-bold">{msg.username}: </span>
                {msg.comment}
              </p>
            ))}
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById("root"));
  </script>
</body>
</html>
